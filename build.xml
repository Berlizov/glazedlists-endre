<!--
   Glazed Lists
   Copyright 2003-2005 publicobject.com, O'Dell Engineering Ltd.
-->

<project name="glazedlists" default="jar" basedir=".">

    <property name="java.target.version" value="1.5"/>
    <property name="java.target.version.fileFriendlyName" value="java15"/>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
       BUILD ADMINISTRATION
       Create build directories and set up necessary paths.
    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<target name="init">
	</target>

	<target name="clean"
		description="Clean up generated files, forcing them to be rebuilt.">
		<!-- Delete the directories where generated files fall -->
		<delete dir="classes"/>
		<!-- Delete the Java 1.4 build directory -->
		<delete dir="java14_glazedlists"/>
		<!-- Delete the documentation directories -->
		<delete dir="docs/api"/>
		<delete dir="docs/impl"/>
		<delete>
			<fileset dir="${basedir}" defaultexcludes="no">
                <!-- Delete temporary files from JEdit -->
				<include name="**/*~"/>
                <!-- Delete the generated .jar and demo jar -->
				<include name="glazedlists*.jar"/>
                <!-- Delete the generated source -->
				<include name="glazedlists*.zip"/>
			</fileset>
		</delete>
	</target>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	   JAVADOC
	   Construct a browsable API.
	 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<target name="docs" depends="init"
		description="Scan the source code to generate the Javadoc API.">
		<mkdir dir="docs"/>
		<tstamp prefix="javadoc">
			<format property="datestamp" pattern="yyyy-MM-dd H:mm"/>
		</tstamp>
		<!-- document all the source -->
		<javadoc
			destdir="docs/api" author="true" use="true" windowtitle="Glazed Lists" source="${java.target.version}">
			<packageset dir="source">
				<exclude name="**/impl/**"/>
			</packageset>
			<doctitle><![CDATA[<h1>Glazed Lists</h1>]]></doctitle>
			<bottom><![CDATA[<a href="http://publicobject.com/glazedlists/" target="_top">Glazed Lists</a>, Copyright &#169; 2003-2005 O'Dell Engineering.<br>Generated ${javadoc.datestamp}]]></bottom>
			<link href="http://java.sun.com/j2se/${java.target.version}/docs/api/"/>
			<link href="http://www.eclipse.org/documentation/html/plugins/org.eclipse.platform.doc.isv/doc/reference/api/"/>
		</javadoc>
	</target>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	   JAR
	   Construct the .jar file for use in a library.
	 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<target name="jar" depends="init,compile"
		description="Creates glazedlists jar file containing all UI libraries.">
		<tstamp prefix="jar">
			<format property="datestamp" pattern="yyyy-MM-dd H:mm"/>
		</tstamp>
		<jar destfile="glazedlists_${java.target.version.fileFriendlyName}.jar" update="true" index="true">
			<fileset dir="classes"/>
			<fileset dir=".">
				<include name="resources/**"/>
			</fileset>
			<manifest>
				<attribute name="Main-Class" value="ca.odell.glazedlists.impl.Main"/>
				<attribute name="Sealed" value="true"/>
				<attribute name="Built-By" value="${user.name}"/>
				<attribute name="Built-At" value="${jar.datestamp}"/>
				<attribute name="Implementation-Version" value="${jar.datestamp}"/>
				<attribute name="Implementation-Title" value="Glazed Lists"/>
				<attribute name="Implementation-URL" value="http://publicobject.com/glazedlists/"/>
				<attribute name="Contributors" value="Jesse Wilson, Kevin Maltby, James Lemieux, Rob Eden"/>
                <attribute name="Source-Version" value="JDK ${java.target.version}"/>
			</manifest>
		</jar>
	</target>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	   COMPILE
	 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<target name="compile" depends="core,swing"
		description="Compile the default components of the source.">
	</target>

	<target name="compileall" depends="core,migrationkit,swing,swt,ktable,io"
		description="Compile all components of the source.">
	</target>

	<target name="core" depends="init">
		<mkdir dir="classes"/>
		<javac destdir="classes" srcdir="source" debug="on" source="${java.target.version}" deprecation="on">
                <!-- swing -->
                <exclude name="**/swing/**"/>
                <!-- io -->
                <exclude name="**/ctp/**"/>
                <exclude name="**/io/**"/>
                <exclude name="**/nio/**"/>
                <exclude name="**/pmap/**"/>
                <exclude name="**/rbp/**"/>
		</javac>
	</target>

    <target name="migrationkit" depends="core">
        <javac destdir="classes" srcdir="source" debug="on" source="${java.target.version}" deprecation="on">
            <include name="**/migrationkit/**"/>
        </javac>
    </target>

	<target name="swing" depends="core">
		<javac destdir="classes" srcdir="source" debug="on" source="${java.target.version}" deprecation="on">
			<include name="**/swing/**"/>
			<exclude name="**/migrationkit/**"/>
		</javac>
	</target>

	<target name="io" depends="core">
		<javac destdir="classes" srcdir="source" debug="on" source="${java.target.version}" deprecation="on">
			<include name="**/ctp/**"/>
			<include name="**/io/**"/>
			<include name="**/nio/**"/>
			<include name="**/pmap/**"/>
			<include name="**/rbp/**"/>
		</javac>
	</target>


    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
       EXTENSIONS
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="swt" depends="core">
        <mkdir dir="extensions/swt/lib"/>
        <java classname="ca.odell.glazedlists.impl.HttpClient">
            <classpath path="classes"/>
            <arg value="https://glazedlists.dev.java.net/files/documents/1073/25145/swt-api.jar"/>
            <arg value="extensions/swt/lib/swt-api.jar"/>
        </java>
        <javac destdir="classes" srcdir="extensions/swt/source" debug="on" source="${java.target.version}" deprecation="on">
            <classpath>
                <fileset dir="extensions/swt/lib/" includes="*.jar"/>
            </classpath>
        </javac>
    </target>

    <target name="ktable" depends="core,swt">
        <mkdir dir="extensions/ktable/lib"/>
        <java classname="ca.odell.glazedlists.impl.HttpClient">
            <classpath path="classes"/>
            <arg value="https://glazedlists.dev.java.net/files/documents/1073/24419/ktable.jar"/>
            <arg value="extensions/ktable/lib/ktable.jar"/>
        </java>
        <javac destdir="classes" srcdir="extensions/ktable/source" debug="on" source="${java.target.version}" deprecation="on">
            <classpath>
                <fileset dir="extensions/ktable/lib/" includes="*.jar"/>
                <fileset dir="extensions/swt/lib/" includes="*.jar"/>
            </classpath>
        </javac>
    </target>


    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
       SPECIAL TARGETS
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="java14" depends="init,compileall,compiletests" description="Compile Glazed Lists for deployment on a J2SE 1.4">
        <!-- clean the java14 directory -->
        <delete dir="java14_glazedlists"/>
        <mkdir dir="java14_glazedlists/source"/>
        <mkdir dir="java14_glazedlists/test"/>

        <!-- download the declawer build tool -->
        <mkdir dir="tools"/>
        <java classname="ca.odell.glazedlists.impl.HttpClient">
            <classpath path="classes"/>
            <arg value="https://glazedlists.dev.java.net/files/documents/1073/25249/declawer.jar"/>
            <arg value="tools/declawer.jar"/>
        </java>

        <!-- Declaw the source code to the java14 directory. -->
        <java classname="com.publicobject.declawer.Declawer">
            <classpath path="tools/declawer.jar"/>

            <arg value="source"/>
            <arg value="${ant.home}/lib/junit.jar"/>
            <arg value="java14_glazedlists/source"/>
        </java>

        <!-- Declaw the tests to the java14 directory. -->
        <java classname="com.publicobject.declawer.Declawer">
            <classpath path="tools/declawer.jar"/>

            <arg value="test"/>
            <arg value="classes${path.separator}${ant.home}/lib/junit.jar"/>
            <arg value="java14_glazedlists/test"/>
        </java>

        <!-- Copy all of the resources (non-source files) to the java14 directory. -->
        <copy todir="java14_glazedlists">
            <fileset dir=".">
                <exclude name="java14_glazedlists/**"/>
                <exclude name="source/**"/>
                <exclude name="test/**"/>
                <exclude name="classes/**"/>
                <exclude name="docs/**"/>
            </fileset>
        </copy>

        <!-- Alter the target platform in the java14 build.xml file from 1.5 to 1.4. -->
        <replace file="java14_glazedlists/build.xml" token="&lt;property name=&quot;java.target.version&quot; value=&quot;1.5&quot;/&gt;" value="&lt;property name=&quot;java.target.version&quot; value=&quot;1.4&quot;/&gt;"/>
        <replace file="java14_glazedlists/build.xml" token="&lt;property name=&quot;java.target.version.fileFriendlyName&quot; value=&quot;java15&quot;/&gt;" value="&lt;property name=&quot;java.target.version.fileFriendlyName&quot; value=&quot;java14&quot;/&gt;"/>
    </target>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	   REDISTRIBUTING THE SOURCE
	   Package the entire Glazed Lists source tree in a .zip file.
	 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<target name="dist" depends="init,clean"
		description="Create a .zip file of the source for backup or distribution.">
		<zip destfile="glazedlists-source_${java.target.version.fileFriendlyName}.zip" basedir=".">
			<exclude name="classes/**"/>
			<exclude name="docs/**"/>
			<exclude name="tools/**"/>
			<exclude name="glazedlists-source_*.zip"/>
			<exclude name="extensions/**/lib/**"/>
			<exclude name="www/**"/>
		</zip>
	</target>

    <target name="upload" depends="dist"
        description="Upload binaries to java.net">
        <taskdef resource="org/kohsuke/javanettasks.properties" />
        <tstamp prefix="jar">
            <format property="datestamp" pattern="yyyy-MM-dd H:mm"/>
        </tstamp>
        <javaNetUpload projectName="glazedlists"
            toFile="/latest_build/glazedlists-source_${java.target.version.fileFriendlyName}.zip"
            fromFile="glazedlists-source_${java.target.version.fileFriendlyName}.zip"
            fileDescription="Snapshot build by ${user.name} at ${jar.datestamp}"
            overwrite="no"
            fileStatus="Draft"/>
	</target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
       TEST
       Compile unit tests and run them using JUnit.
       This task depends on JUnit, available free at http://www.junit.org
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="test" depends="init,compiletests"
            description="Compile unit tests and run them using JUnit.">
            <!-- Verify that JUnit is available on the classpath -->
            <available classname="junit.framework.TestCase" property="junit.present"/>
            <fail unless="junit.present" message="To run this task, install junit.jar and optional.jar into ${ant.home}/lib/ JUnit is available free at http://www.junit.org"/>
            <!-- Execute JUnit tests -->
            <junit printsummary="true" showoutput="false" fork="true"
                    errorProperty="test.failed" failureProperty="test.failed">
                    <assertions>
                            <enable/>
                    </assertions>
                    <classpath path="classes:${ant.home}/lib/junit.jar"/>
                    <formatter type="brief" usefile="false"/>
                    <batchtest>
                            <fileset dir="classes/" includes="**/**Test.class"/>
                    </batchtest>
            </junit>
            <fail message="Tests failed. Check test output." if="test.failed"/>
    </target>

    <target name="compiletests" depends="init,compileall">
        <!-- Compile the test classes from source/ into classes/ -->
        <echo>${ant.home}</echo>
        <javac destdir="classes" srcdir="test" debug="on" source="${java.target.version}" deprecation="on">
            <classpath>
                <fileset dir="extensions" includes="**/*.jar"/>
                <fileset file="${ant.home}/lib/junit.jar"/>
            </classpath>
        </javac>
    </target>


    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
       DEMO JAR
       Currently the demo classes are stored in the test directory
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="demojar" depends="init,clean,core,swing"
        description="Create a .jar file with a demo application.">
        <javac destdir="classes" srcdir="test" deprecation="on">
            <include name="**/demo/**"/>
            <exclude name="**/swt/**"/>
        </javac>
        <jar destfile="glazedlists-demo.jar" update="true" index="true">
            <fileset dir="classes"/>
            <fileset dir=".">
                <include name ="**/resources/**"/>
            </fileset>
            <fileset dir="test">
                <include name ="**/demo/*.gif"/>
            </fileset>
            <manifest>
                <attribute name="Main-Class" value="ca.odell.glazedlists.demo.issuebrowser.swing.IssuesBrowser"/>
            </manifest>
        </jar>
	</target>

</project>